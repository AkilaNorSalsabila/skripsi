<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <title>Skor</title>

    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/skor.css') }}">
    
    <style>
        @keyframes winner-jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }
        .perfect-score {
            animation: winner-jump 0.8s infinite ease-in-out;
            border: 6px solid #FFD700 !important;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6) !important;
        }
    </style>
</head>

<body>

    <img src="{{ url_for('static', filename='img/vegetables_corner_top1.png') }}" class="decor decor-right" alt="">
    <img src="{{ url_for('static', filename='img/vegetables_corner1.png') }}" class="decor decor-left" alt="">

    <a href="/pilih_level" class="back-button">
        <img src="{{ url_for('static', filename='img/back.png') }}" alt="Kembali">
    </a>

    <header class="header">
        <h1 id="title-text">Skor</h1>
        <button id="btn-speak" class="speak-btn" aria-label="Putar suara">
            <img src="{{ url_for('static', filename='img/sound.png') }}" alt="Suara">
        </button>
    </header>

    <main class="score-main">
        <div class="score-container">
            <div id="score-box">0/100</div>

            <div class="buttons">
                <button id="btn-retry" class="icon-btn" title="Ulang">
                    <img src="{{ url_for('static', filename='img/repeat.png') }}" alt="Ulang">
                </button>
                <button id="btn-next" class="icon-btn" title="Lanjut">
                    <img src="{{ url_for('static', filename='img/next.png') }}" alt="Lanjut">
                </button>
            </div>
        </div>
    </main>

    <div id="emoji-overlay"></div>
    <canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;"></canvas>

    <audio id="good-sound" src="{{ url_for('static', filename='sounds/goodresult.mp3') }}"></audio>
    <audio id="fail-sound" src="{{ url_for('static', filename='sounds/fail.mp3') }}"></audio>
    
    <audio id="score-voice"></audio>

    <script>
        // ================== INITIAL SETTINGS ==================
        const lang = localStorage.getItem("gameLang") || "id";
        const titleText = document.getElementById("title-text");
        titleText.textContent = (lang === "en") ? "Score" : "Skor";
        document.title = (lang === "en") ? "Score" : "Skor";

        // ================== LOGIKA SCORE ==================
        function getFinalScore() {
            // Mengambil skor utama dari 'puzzleScore' (sinkron dengan puzzle.js)
            let currentScore = localStorage.getItem("puzzleScore");
            let finalScore = 0;

            if (currentScore !== null) {
                finalScore = parseInt(currentScore, 10);
            } else {
                // Fallback jika puzzleScore kosong, hitung dari correctCount
                const correctCount = parseInt(localStorage.getItem("correctCount") || "0", 10);
                const totalQuestions = parseInt(localStorage.getItem("totalQuestions") || "5", 10);
                finalScore = Math.round((correctCount / totalQuestions) * 100);
            }

            // Batasi skor minimal 0 dan maksimal 100
            finalScore = Math.max(0, Math.min(100, finalScore));
            
            // Simpan sebagai finalScore untuk referensi halaman ini
            localStorage.setItem("finalScore", finalScore);
            return finalScore;
        }

        const finalScore = getFinalScore();
        const scoreBox = document.getElementById("score-box");
        scoreBox.textContent = `${finalScore}/100`;

        // ================== MAPPING SUARA REKAMAN ==================
        const audioMap = {
            "id": {
                0: "Nol.mp4",
                20: "Dua Puluh.mp4",
                40: "Empat Puluh.mp4",
                60: "Enam Puluh.mp4",
                80: "Delapan pulih.mp4", // Sesuai typo di folder kamu
                100: "Seratus.mp4"
            },
            "en": {
                0: "Zero.mp3",
                20: "Twenty.mp3",
                40: "Forty.mp3",
                60: "Sixty.mp3",
                80: "Eighty.mp3",
                100: "One Hundred.mp3"
            }
        };

        const scoreVoice = document.getElementById("score-voice");
        
        function playScoreVoice() {
            const folder = (lang === "en") ? "Score En" : "Score Id";
            const fileName = audioMap[lang][finalScore] || audioMap[lang][0];
            
            scoreVoice.src = `/static/sounds/${folder}/${fileName}`;
            scoreVoice.play().catch(e => console.log("Audio play error:", e));
        }

        // ================== AUDIO EFEK ==================
        const goodSound = document.getElementById("good-sound");
        const failSound = document.getElementById("fail-sound");

        // ================== EMOJI & CONFETTI ==================
        function showEmojiOverlay(type) {
            const overlay = document.getElementById("emoji-overlay");
            overlay.innerHTML = "";
            overlay.style.display = "block";
            const emojiChar = (type === "good") ? "üëç" : "üò¢";
            for (let i = 0; i < 25; i++) {
                const span = document.createElement("span");
                span.classList.add("emoji");
                span.textContent = emojiChar;
                span.style.top = Math.random() * 90 + "vh";
                span.style.left = Math.random() * 90 + "vw";
                span.style.animation = `floatDown ${3 + Math.random() * 3}s ease forwards`;
                overlay.appendChild(span);
            }
            setTimeout(() => overlay.style.display = "none", 6000);
        }

        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let particles = [];
            const colors = ['#eb6383', '#fa9191', '#ffe9c5', '#b4f2e1', '#00B4E1', '#FFD700'];
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 6.28,
                    rotation: Math.random() * 0.2 - 0.1
                });
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.y += p.speed;
                    p.angle += p.rotation;
                    ctx.fillStyle = p.color;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle);
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                    if (p.y > canvas.height) particles[i].y = -20;
                });
                if(particles.length > 0) requestAnimationFrame(draw);
            }
            draw();
        }

        // ================== EKSEKUSI HASIL ==================
        window.addEventListener("load", () => {
            if (finalScore >= 60) {
                goodSound.play().catch(()=>{});
                showEmojiOverlay("good");
                if (finalScore === 100) {
                    startConfetti();
                    scoreBox.classList.add("perfect-score");
                }
            } else {
                failSound.play().catch(()=>{});
                showEmojiOverlay("bad");
            }

            setTimeout(() => {
                playScoreVoice();
            }, 1000);
        });

        document.getElementById("btn-speak").addEventListener("click", playScoreVoice);

        // ================== NAVIGASI & RESET ==================
        function resetGameData() {
            const savedLang = localStorage.getItem("gameLang");
            const lastLevel = localStorage.getItem("lastLevel");
            
            // Menghapus semua data skor lama agar tidak menumpuk di game berikutnya
            const keysToRemove = [
                "puzzleScore", 
                "finalScore", 
                "correctCount", 
                "totalQuestions", 
                "menengahScore",
                "currentIndex",
                "sessionQuestions"
            ];
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Kembalikan bahasa dan level terakhir
            if (savedLang) localStorage.setItem("gameLang", savedLang);
            if (lastLevel) localStorage.setItem("lastLevel", lastLevel);
        }

        document.getElementById("btn-retry").addEventListener("click", () => {
            const lastLevel = localStorage.getItem("lastLevel") || "mudah";
            resetGameData();
            const routes = { 
                "mudah": "/level_mudah", 
                "menengah": "/level_menengah", 
                "sulit": "/puzzle_sulit1" 
            };
            window.location.href = routes[lastLevel] || "/pilih_level";
        });

        document.getElementById("btn-next").addEventListener("click", () => {
            resetGameData();
            window.location.href = "/pilih_level";
        });
    </script>
</body>
</html>