<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Skor</title>

  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/skor.css') }}">
</head>

<body>

  <!-- dekor pojok -->
  <img src="{{ url_for('static', filename='img/vegetables_corner_top1.png') }}" class="decor decor-right" alt="">
  <img src="{{ url_for('static', filename='img/vegetables_corner1.png') }}" class="decor decor-left" alt="">

  <!-- back -->
  <a href="/pilih_level" class="back-button">
    <img src="{{ url_for('static', filename='img/back.png') }}" alt="Kembali">
  </a>

  <!-- Header -->
  <header class="header">
    <h1 id="title-text">Skor</h1>
    <button id="btn-speak" class="speak-btn" aria-label="Putar suara">
      <img src="{{ url_for('static', filename='img/sound.png') }}" alt="Suara">
    </button>
  </header>

  <!-- Konten utama -->
  <main class="score-main">
    <div class="score-container">
      <div id="score-box">0/100</div>

      <div class="buttons">
        <button id="btn-retry" class="icon-btn" title="Ulang">
          <img src="{{ url_for('static', filename='img/repeat.png') }}" alt="Ulang">
        </button>
        <button id="btn-next" class="icon-btn" title="Lanjut">
          <img src="{{ url_for('static', filename='img/next.png') }}" alt="Lanjut">
        </button>
      </div>
    </div>
  </main>

  <!-- overlay emoji -->
  <div id="emoji-overlay"></div>

  <!-- suara hasil akhir -->
  <audio id="good-sound" src="{{ url_for('static', filename='sounds/goodresult.mp3') }}"></audio>
  <audio id="fail-sound" src="{{ url_for('static', filename='sounds/fail.mp3') }}"></audio>

  <!-- ================= SCRIPT ================= -->
  <script>
    // ================== BAHASA ==================
    const lang = localStorage.getItem("gameLang") || "id";

    const titleText = document.getElementById("title-text");
    titleText.textContent = (lang === "en") ? "Score" : "Skor";
    document.title = (lang === "en") ? "Score" : "Skor";

    // ================== SCORE ==================
    function getFinalScore() {
      let finalScore = parseInt(localStorage.getItem("finalScore"), 10);

      if (isNaN(finalScore)) {
        const correctCount = parseInt(localStorage.getItem("correctCount") || "0", 10);
        const totalQuestions = parseInt(localStorage.getItem("totalQuestions") || "5", 10);

        finalScore = Math.round((correctCount / totalQuestions) * 100);
        localStorage.setItem("finalScore", finalScore);
      }

      return finalScore;
    }

    const finalScore = getFinalScore();
    document.getElementById("score-box").textContent = `${finalScore}/100`;

    // ================== AUDIO ==================
    const goodSound = document.getElementById("good-sound");
    const failSound = document.getElementById("fail-sound");
    goodSound.volume = 0.5;
    failSound.volume = 0.5;

    // ================== EMOJI ==================
    function showEmojiOverlay(type) {
      const overlay = document.getElementById("emoji-overlay");
      overlay.innerHTML = "";
      overlay.style.display = "block";

      const emojiChar = (type === "good") ? "üëç" : "üò¢";

      for (let i = 0; i < 25; i++) {
        const span = document.createElement("span");
        span.classList.add("emoji");
        span.textContent = emojiChar;
        span.style.top = Math.random() * 90 + "vh";
        span.style.left = Math.random() * 90 + "vw";
        span.style.animation = `floatDown ${3 + Math.random() * 3}s ease forwards`;
        overlay.appendChild(span);
      }

      setTimeout(() => overlay.style.display = "none", 6000);
    }

    // ================== PLAY RESULT ==================
    if (finalScore >= 60) {
      goodSound.play();
      showEmojiOverlay("good");
    } else {
      failSound.play();
      showEmojiOverlay("bad");
    }

    // ================== AUTO TTS ==================
    window.addEventListener("load", () => {
      const scoreText = (lang === "en")
        ? `Your score is ${finalScore} out of 100`
        : `Skor kamu ${finalScore} dari 100`;

      const utter = new SpeechSynthesisUtterance(scoreText);
      utter.lang = (lang === "en") ? "en-US" : "id-ID";
      speechSynthesis.speak(utter);
    });

    // ================== HELPER RESET ==================
    function resetGameDataButKeepLang() {
      const savedLang = localStorage.getItem("gameLang");
      const lastLevel = localStorage.getItem("lastLevel");

      localStorage.removeItem("finalScore");
      localStorage.removeItem("correctCount");
      localStorage.removeItem("totalQuestions");

      if (savedLang) localStorage.setItem("gameLang", savedLang);
      if (lastLevel) localStorage.setItem("lastLevel", lastLevel);
    }

    // ================== RETRY ==================
    document.getElementById("btn-retry").addEventListener("click", () => {
      const lastLevel = localStorage.getItem("lastLevel") || "mudah";
      resetGameDataButKeepLang();

      if (lastLevel === "mudah") window.location.href = "/level_mudah";
      else if (lastLevel === "menengah") window.location.href = "/level_menengah";
      else if (lastLevel === "sulit") window.location.href = "/puzzle_sulit1";
      else window.location.href = "/pilih_level";
    });

    // ================== NEXT ==================
    document.getElementById("btn-next").addEventListener("click", () => {
      resetGameDataButKeepLang();
      window.location.href = "/pilih_level";
    });

    // ================== MANUAL TTS ==================
    document.getElementById("btn-speak").addEventListener("click", () => {
      const scoreText = (lang === "en")
        ? `Your score is ${finalScore} out of 100`
        : `Skor kamu ${finalScore} dari 100`;

      const utter = new SpeechSynthesisUtterance(scoreText);
      utter.lang = (lang === "en") ? "en-US" : "id-ID";
      speechSynthesis.speak(utter);
    });
  </script>

</body>
</html>
